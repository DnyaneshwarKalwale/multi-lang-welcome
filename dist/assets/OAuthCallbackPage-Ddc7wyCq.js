import{j as r}from"./ui-vendor-yLFRes2f.js";import{u as S,d as O,r as p}from"./react-vendor-DWSrZqKN.js";import{a as x,s as y,J as f}from"./index-CqPKG3Vx.js";import{m as A}from"./utils-vendor-DFcOAB1P.js";function j(){const t=S(),l=O(),{fetchUser:h,updateUserProfile:C}=x(),[I,v]=p.useState(!0),[b,c]=p.useState(null);return p.useEffect(()=>{(async()=>{const s=new URLSearchParams(l.search),m=s.get("token"),k=s.get("onboarding")==="true",d=s.get("error"),u=s.get("linkedin_connected")==="true";if(console.log("OAuth callback received with params:",{token:m?"(token present)":"(no token)",onboarding:k,error:d,linkedinConnected:u}),d){console.error("OAuth error from server:",d),c(`Authentication failed: ${d}`),setTimeout(()=>t("/",{replace:!0}),2e3);return}if(!m){console.error("No authentication token received"),c("No authentication token received"),setTimeout(()=>t("/",{replace:!0}),2e3);return}let n="linkedin";if(console.log("OAuth callback - Full pathname:",l.pathname),console.log("OAuth callback - Full URL:",window.location.href),u)n=localStorage.getItem("auth-method")==="google"?"google":"linkedin",console.log("OAuth callback - LinkedIn connected to existing account, using auth method:",n);else if(l.pathname.includes("linkedin")||window.location.href.includes("linkedin"))n="linkedin",console.log("OAuth callback - Setting auth method to LinkedIn based on URL path");else if(l.pathname.includes("google"))n="google";else if(l.pathname.includes("social-callback")){const a=new URLSearchParams(l.search).get("provider");a==="linkedin"||a!=null&&a.toLowerCase().includes("linkedin")?(n="linkedin",console.log("OAuth callback - Setting auth method to LinkedIn based on provider param")):a==="google"&&(n="google")}console.log("OAuth callback - Determined authMethod:",n);try{u||(f.clearAllTokens(),localStorage.removeItem("onboardingCompleted"),localStorage.removeItem("onboardingStep")),console.log("OAuth callback - Storing token with authMethod:",n),f.storeToken(m,n),console.log("OAuth callback - Fetching user data");const e=await h();if(!e){console.error("OAuth callback - User data could not be loaded"),c("Could not load user data, please try again"),setTimeout(()=>t("/",{replace:!0}),2e3);return}console.log("OAuth callback - User data loaded successfully",{id:e.id,linkedinConnected:e.linkedinConnected,authMethod:e.authMethod});const a=localStorage.getItem("pendingInvitationToken"),g=localStorage.getItem("redirectAfterAuth");if(a)console.log("OAuth callback - Redirecting to handle pending invitation"),t(`/invitations?token=${a}`,{replace:!0}),localStorage.removeItem("pendingInvitationToken");else if(u){console.log("OAuth callback - LinkedIn connected, redirecting to dashboard"),localStorage.setItem("onboardingCompleted","true");const i=localStorage.getItem("auth-method");i&&localStorage.setItem("auth-method",i),e&&(e.onboardingCompleted=!0,e.linkedinConnected=!0,C({linkedinConnected:!0,onboardingCompleted:!0})),localStorage.removeItem("linkedin-login-type"),setTimeout(async()=>{try{console.log("Force refreshing user data after LinkedIn connection");const o=await h(!0);console.log("Refreshed user data after LinkedIn connection:",{linkedinConnected:o==null?void 0:o.linkedinConnected,authMethod:o==null?void 0:o.authMethod}),o!=null&&o.linkedinConnected&&(console.log("Confirming LinkedIn connection in localStorage"),localStorage.setItem("linkedinConnected","true"))}catch(o){console.error("Error refreshing user data:",o)}},100),t("/dashboard?linkedin=connected",{replace:!0}),localStorage.removeItem("redirectAfterAuth")}else if(g)console.log("OAuth callback - Redirecting to previously stored path:",g),g==="/dashboard"&&(localStorage.setItem("onboardingCompleted","true"),e&&(e.onboardingCompleted=!0)),t(g,{replace:!0}),localStorage.removeItem("redirectAfterAuth");else{const i=e.onboardingCompleted;console.log("OAuthCallback - Onboarding param:",k),console.log("OAuthCallback - onboardingCompleted from server:",i),k||!i?(console.log("OAuthCallback - Redirecting to onboarding"),t("/onboarding/welcome",{replace:!0})):(console.log("OAuthCallback - Redirecting to dashboard"),localStorage.setItem("onboardingCompleted","true"),e&&(e.onboardingCompleted=!0),t("/dashboard",{replace:!0}))}}catch(e){console.error("OAuth callback - Error processing authentication:",e),c("Failed to process authentication. Please try again."),setTimeout(()=>t("/",{replace:!0}),2e3)}finally{v(!1)}})()},[t,l,h]),r.jsx("div",{className:"min-h-screen flex items-center justify-center bg-background",children:r.jsx("div",{className:"text-center",children:I?r.jsxs(A.div,{initial:{opacity:0},animate:{opacity:1},className:"flex flex-col items-center gap-4",children:[r.jsx(y,{className:"h-8 w-8 animate-spin text-primary"}),r.jsx("p",{className:"text-lg text-gray-600",children:"Processing your login..."})]}):b?r.jsx(A.div,{initial:{opacity:0},animate:{opacity:1},className:"text-red-600",children:b}):null})})}export{j as default};
